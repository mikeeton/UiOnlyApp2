@using System.Security.Claims

@{
    var isPatient = User.IsInRole("Patient");
    var patientIdClaim = User.FindFirst("PatientId")?.Value ?? "";
}

<div class="card heatmap-card shadow-sm">
    <div class="card-header fw-semibold d-flex align-items-center gap-2">
        <i class="bi bi-grid-3x3-gap-fill text-primary me-2"></i>
        <span>Pressure Map</span>

        <div class="ms-auto d-flex flex-wrap gap-2 align-items-center">
            <!-- Only date + palette on patient dashboard -->
            <select id="heatmapDate" class="form-select form-select-sm" style="min-width: 140px;">
                <option value="">Date…</option>
            </select>

            <select id="paletteSelect" class="form-select form-select-sm">
                <option value="default">Default Palette</option>
                <option value="warm">Warm Gradient</option>
                <option value="cool">Cool Gradient</option>
                <option value="contrast">High Contrast</option>
            </select>
        </div>
    </div>

    <div class="card-body p-0">
        <div class="heatmap-wrap ratio ratio-1x1">
            <canvas id="heatmapCanvas"></canvas>
        </div>

        <div class="d-flex flex-wrap justify-content-between gap-3 px-3 pt-3 pb-2 small">
            <div>
                <div class="text-muted text-uppercase" style="font-size:.7rem; letter-spacing:.12em;">
                    Peak Pressure Index
                </div>
                <div id="kpiPPI" class="fw-bold">—</div>
            </div>
            <div>
                <div class="text-muted text-uppercase" style="font-size:.7rem; letter-spacing:.12em;">
                    Contact Area %
                </div>
                <div id="kpiContactArea" class="fw-bold">—</div>
            </div>
            <div>
                <div class="text-muted text-uppercase" style="font-size:.7rem; letter-spacing:.12em;">
                    Status
                </div>
                <div id="kpiAlert" class="fw-bold">—</div>
            </div>
        </div>

        <div class="p-3 small text-muted" id="heatmapStatus">
            @if (isPatient && !string.IsNullOrEmpty(patientIdClaim))
            {
                @:Loading your latest session map…
            }
            else
            {
                @:Select a patient and date to load a session heatmap.
            }
        </div>
    </div>
</div>
