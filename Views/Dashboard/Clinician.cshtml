@{
    ViewData["Title"] = "Clinician Dashboard";
}

<div class="container py-4">
    <!-- HEADER -->
    <section class="mb-4">
        <div class="hero-slab p-4 p-md-5 mb-3">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <span class="badge text-bg-primary mb-3">Clinician view</span>
                    <h1 class="display-6 mb-2">Patient monitoring workspace</h1>
                    <p class="text-muted mb-3">
                        Review pressure mapping trends, spot high-risk sessions, and drill into individual
                        patients’ heatmaps. All metrics are computed from the same sensor data used in the patient view.
                    </p>
                    <div class="d-flex flex-wrap gap-2 small text-muted">
                        <span><i class="bi bi-people-fill me-1"></i>Multi-patient oversight</span>
                        <span><i class="bi bi-bell me-1"></i>High-risk flags</span>
                    </div>
                </div>
                <div class="col-md-4 mt-4 mt-md-0 text-md-end">
                    <div class="d-inline-flex flex-column align-items-md-end align-items-start gap-2 small">
                        <div>
                            <label class="form-label mb-1 small text-muted">Select patient</label>
                            <select id="selPatient" class="form-select form-select-sm">
                                <option value="">Choose patient…</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label mb-1 small text-muted">Time window</label>
                            <select id="clinRange" class="form-select form-select-sm">
                                <option value="1h">Last 1h</option>
                                <option value="6h">Last 6h</option>
                                <option value="24h" selected>Last 24h</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- TOP ROW: TREND + HEATMAP -->
    <section class="mb-4">
        <div class="row g-3">
            <!-- Trend chart -->
            <div class="col-lg-7">
                <div class="card shadow-sm rounded-4">
                    <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
                        <span>Trend overview</span>
                        <span class="small text-muted" id="clinTrendSubtitle">
                            Select a patient to view their sessions
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="ratio ratio-16x9">
                            <canvas id="clinTrendChart"></canvas>
                        </div>
                        <p class="small text-muted mb-0 mt-2">
                            Blue: <strong>Peak Pressure Index</strong> (max sensor pressure per session).<br />
                            Green: <strong>Contact Area %</strong> (percentage of sensors above load threshold).
                        </p>
                    </div>
                </div>
            </div>

            <!-- Heatmap for selected patient -->
            <div class="col-lg-5">
                @await Html.PartialAsync("_Heatmap")
            </div>
        </div>
    </section>

    <!-- BOTTOM ROW: FLAGS + NOTES -->
    <section>
        <div class="row g-3">
            <!-- Risk flags -->
            <div class="col-lg-6">
                <div class="card shadow-sm rounded-4">
                    <div class="card-header fw-semibold">
                        Risk flags
                    </div>
                    <div class="card-body p-0">
                        <ul id="flagList" class="list-group list-group-flush small">
                            <li class="list-group-item text-muted">
                                Select a patient to see recent high-risk sessions.
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Clinician notes / comments -->
            <div class="col-lg-6">
                <div class="card shadow-sm rounded-4">
                    <div class="card-header fw-semibold">
                        Clinician notes
                    </div>
                    <div class="card-body" id="clinThread">
                        <div class="d-flex align-items-start mb-3 comment">
                            <div class="avatar me-2">C</div>
                            <div class="bubble">
                                <div class="small fw-semibold">Dr. Patel</div>
                                <div class="small text-muted mb-1">Today, 09:14</div>
                                <div class="small">
                                    Use this space to record your observations for each patient’s pressure profile,
                                    including posture advice and follow-up actions.
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <form class="d-flex gap-2" onsubmit="return UI && UI.addClinNote && UI.addClinNote(event);">
                            <input type="text" class="form-control form-control-sm" id="clinNoteInput"
                                   placeholder="Add a note about this patient…" />
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="bi bi-send"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

@section Scripts {
    <!-- Chart.js is already in _Layout, but safe to include again if needed -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="~/js/charts.js" asp-append-version="true"></script>
    <script src="~/js/sensor-metrics.js" asp-append-version="true"></script>

    <script>
        (function () {
            let clinChart = null;

            async function updateClinicianTrend() {
                if (!window.SensorData || !window.Charts) return;

                const selPatient = document.getElementById("selPatient");
                const selRange = document.getElementById("clinRange");
                const canvas = document.getElementById("clinTrendChart");
                const subtitle = document.getElementById("clinTrendSubtitle");
                const flagList = document.getElementById("flagList");

                if (!selPatient || !canvas) return;

                const pid = selPatient.value;
                if (!pid) {
                    if (clinChart) { clinChart.destroy(); clinChart = null; }
                    if (subtitle) subtitle.textContent = "Select a patient to view their sessions";
                    if (flagList) {
                        flagList.innerHTML = '<li class="list-group-item text-muted">Select a patient to see recent high-risk sessions.</li>';
                    }
                    return;
                }

                const metrics = await SensorData.loadPatientMetrics(pid);
                if (!metrics) {
                    if (subtitle) subtitle.textContent = "No sessions found for selected patient.";
                    return;
                }

                const rangeKey = selRange ? selRange.value : "24h";
                const sliced = SensorData.sliceByRange(metrics, rangeKey);

                if (clinChart) clinChart.destroy();
                clinChart = Charts.mkCompareChart(
                    canvas.getContext("2d"),
                    sliced.labels,
                    sliced.ppi,
                    sliced.contact,
                    "Peak Pressure Index",
                    "Contact Area %"
                );

                if (subtitle) {
                    subtitle.textContent = `${metrics.patientName} · ${sliced.labels.length} sessions`;
                }

                // Build risk flags from ALL metrics, not just sliced, so clinician sees overall pattern
                if (flagList) {
                    flagList.innerHTML = "";

                    const anyHigh = metrics.labels.some((label, idx) => {
                        const ppi = metrics.ppiSeries[idx];
                        const contact = metrics.contactSeries[idx];

                        const isHigh = (ppi >= 220 || contact >= 70);
                        const isModerate = !isHigh && (ppi > 20 || contact > 10);

                        if (!isHigh && !isModerate) return false;

                        const li = document.createElement("li");
                        li.className = "list-group-item d-flex justify-content-between align-items-center";

                        let tag = "";
                        let badgeClass = "";

                        if (isHigh) {
                            tag = "High risk";
                            badgeClass = "badge rounded-pill text-bg-danger";
                        } else {
                            tag = "Monitor";
                            badgeClass = "badge rounded-pill text-bg-warning text-dark";
                        }

                        li.innerHTML = `
                            <div>
                                <div class="fw-semibold small">${label}</div>
                                <div class="small text-muted">
                                    PPI: ${ppi.toFixed(0)} · Contact: ${contact.toFixed(1)}%
                                </div>
                            </div>
                            <span class="${badgeClass}">${tag}</span>
                        `;

                        flagList.appendChild(li);
                        return isHigh;
                    });

                    if (!anyHigh && flagList.children.length === 0) {
                        const li = document.createElement("li");
                        li.className = "list-group-item text-muted";
                        li.textContent = "No high-risk sessions detected in the loaded history.";
                        flagList.appendChild(li);
                    }
                }
            }

            function initClinicianPage() {
                if (!window.SensorData) return;

                const selPatient = document.getElementById("selPatient");
                const selRange = document.getElementById("clinRange");

                // Populate patient dropdown from SENSOR_INDEX
                if (selPatient && selPatient.options.length <= 1) {
                    for (const [id, meta] of Object.entries(SensorData.SENSOR_INDEX.patients)) {
                        const opt = document.createElement("option");
                        opt.value = id;
                        opt.textContent = `${meta.name} (${id})`;
                        selPatient.appendChild(opt);
                    }
                }

                if (selPatient) selPatient.addEventListener("change", updateClinicianTrend);
                if (selRange) selRange.addEventListener("change", updateClinicianTrend);
            }

            // Simple "add note" handler for the notes card
            window.UI = window.UI || {};
            window.UI.addClinNote = function (e) {
                e.preventDefault();
                const input = document.getElementById("clinNoteInput");
                const thread = document.getElementById("clinThread");
                if (!input || !thread) return false;

                const text = input.value.trim();
                if (!text) return false;

                const wrapper = document.createElement("div");
                wrapper.className = "d-flex align-items-start mb-3 comment";
                wrapper.innerHTML = `
                    <div class="avatar me-2">C</div>
                    <div class="bubble">
                        <div class="small fw-semibold">You</div>
                        <div class="small text-muted mb-1">Just now</div>
                        <div class="small">${text}</div>
                    </div>
                `;
                thread.prepend(wrapper);
                input.value = "";
                return false;
            };

            document.addEventListener("DOMContentLoaded", initClinicianPage);
        })();
    </script>
}
