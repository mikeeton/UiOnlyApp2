@using System.Security.Claims
@{
    ViewData["Title"] = "Patient Dashboard";
    var patientId = User.FindFirst("PatientId")?.Value ?? "";
}

<div class="container py-4">
    <!-- HERO / HEADER -->
    <section class="mb-4">
        <div class="hero-slab p-4 p-md-5 mb-3">
            <div class="row align-items-center">
                <div class="col-md-7">
                    <span class="badge text-bg-primary mb-3">Patient view</span>
                    <h1 class="display-6 mb-2">Welcome back, @User.Identity?.Name</h1>
                    <p class="text-muted mb-3">
                        This dashboard summarizes your recent pressure mapping sessions and highlights
                        any areas that may need attention. Your clinician can also view this data remotely.
                    </p>
                    <div class="d-flex flex-wrap gap-2 small text-muted">
                        <span><i class="bi bi-shield-check me-1"></i>Clinically supervised</span>
                        <span><i class="bi bi-cloud-arrow-up me-1"></i>Secure data upload</span>
                    </div>
                </div>
                <div class="col-md-5 mt-4 mt-md-0 text-md-end">
                    <div class="d-inline-flex flex-column align-items-md-end align-items-start gap-1 small text-muted">
                        <span><i class="bi bi-person-badge me-1"></i>Patient ID: <code>@patientId</code></span>
                        <span><i class="bi bi-activity me-1"></i>Live pressure mapping</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- KPI ROW -->
    <section class="mb-4">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="card kpi">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="kpi-label text-uppercase small">Peak pressure (recent)</div>
                                <div id="kpiTrendPeak" class="kpi-value">—</div>
                                <div class="kpi-subtext small">Highest recorded in recent sessions</div>
                            </div>
                            <div class="bi bi-graph-up"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card kpi">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="kpi-label text-uppercase small">Average contact area</div>
                                <div id="kpiTrendContact" class="kpi-value">—</div>
                                <div class="kpi-subtext small">Proportion of sensors under load</div>
                            </div>
                            <div class="bi bi-bounding-box-circles"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card kpi">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="kpi-label text-uppercase small">High-risk episodes</div>
                                <div id="kpiTrendAlerts" class="kpi-value">—</div>
                                <div class="kpi-subtext small">Across your loaded sessions</div>
                            </div>
                            <div class="bi bi-exclamation-triangle"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- MAIN GRID: TREND + HEATMAP -->
    <section>
        <div class="row g-3">
            <!-- Left: Trend chart -->
            <div class="col-lg-7">
                <div class="card shadow-sm rounded-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <span class="small text-uppercase text-muted" style="letter-spacing:.12em;">
                                Trend over time
                            </span>
                            <div class="fw-semibold">Peak pressure vs contact area</div>
                        </div>
                        <div class="btn-group btn-group-sm" id="trendRangeGroup" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm active" data-range="1h">
                                Last 1h
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-range="6h">
                                Last 6h
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-range="24h">
                                Last 24h
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="ratio ratio-16x9">
                            <canvas id="trendChart"></canvas>
                        </div>
                        <p class="small text-muted mt-2 mb-0">
                            Each point summarises a recorded session. The blue line shows the
                            <strong>Peak Pressure Index</strong> (highest pressure), and the green line
                            shows <strong>Contact Area %</strong> (how much of the surface is loaded).
                        </p>
                    </div>
                </div>
            </div>

            <!-- Right: Heatmap + metrics (partial) -->
            <div class="col-lg-5">
                @await Html.PartialAsync("_Heatmap")
            </div>
        </div>
    </section>
</div>


@section Scripts {
    <script src="~/js/charts.js" asp-append-version="true"></script>
    <script src="~/js/heatmap.js" asp-append-version="true"></script>
    <script src="~/js/sensor-metrics.js" asp-append-version="true"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const email = '@User.Identity?.Name';
                if (!window.SensorData) return;

                const patientId = SensorData.findPatientIdByEmail(email);
                if (!patientId) {
                    console.warn('No patientId mapped for email:', email);
                    return;
                }

                const metrics = await SensorData.loadPatientMetrics(patientId);
                const sessions = metrics.sessions;
                if (!sessions.length) return;

                // ---------- KPI cards ----------
                const elPeak = document.getElementById('kpiPeakValue') || document.getElementById('kpiPeak');
                const elArea = document.getElementById('kpiAreaValue') || document.getElementById('kpiArea');
                const elRisk = document.getElementById('kpiRiskValue') || document.getElementById('kpiEpisodes');

                if (elPeak) elPeak.textContent = Math.round(metrics.summary.peak);
                if (elArea) elArea.textContent = metrics.summary.avgContact.toFixed(1) + ' %';
                if (elRisk) elRisk.textContent = metrics.summary.highEpisodes.toString();

                // ---------- Trend chart ----------
                const trendCanvas = document.getElementById('trendChart');
                let trendChart = null;

                function drawTrend(rangeKey) {
                    if (!trendCanvas || !window.Charts) return;
                    const sliced = SensorData.sliceByRange(metrics, rangeKey);
                    if (trendChart) trendChart.destroy();
                    trendChart = Charts.mkCompareChart(
                        trendCanvas.getContext('2d'),
                        sliced.labels,
                        sliced.ppi,
                        sliced.contact,
                        'Peak Pressure Index',
                        'Contact Area %'
                    );
                }

                drawTrend('24h');
                const btn1h  = document.getElementById('btnRange1h');
                const btn6h  = document.getElementById('btnRange6h');
                const btn24h = document.getElementById('btnRange24h');

                if (btn1h)  btn1h.addEventListener('click', () => drawTrend('1h'));
                if (btn6h)  btn6h.addEventListener('click', () => drawTrend('6h'));
                if (btn24h) btn24h.addEventListener('click', () => drawTrend('24h'));

                // ---------- Heatmap as VIDEO ----------
                const canvas        = document.getElementById('heatmapCanvas');
                const paletteSelect = document.getElementById('paletteSelect') || document.getElementById('selPalette');
                const dateSelect    =
                    document.getElementById('heatmapDate') ||
                    document.getElementById('heatmapDateSelect') ||
                    document.getElementById('selDate');
                const lblTimestamp  = document.getElementById('heatmapTimestamp');

                if (!canvas) return;

                // Populate the DATE dropdown with session dates (2025-10-11, etc.)
                if (dateSelect) {
                    dateSelect.innerHTML = '';
                    sessions.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.dateKey;
                        opt.textContent = s.dateKey;
                        dateSelect.appendChild(opt);
                    });
                    // select the most recent session by default
                    dateSelect.value = sessions[sessions.length - 1].dateKey;
                }

                // Helper: get session for currently selected date
                function getSelectedSession() {
                    if (!dateSelect) return sessions[sessions.length - 1];
                    const val = dateSelect.value;
                    const found = sessions.find(s => s.dateKey === val);
                    return found || sessions[sessions.length - 1];
                }

                // Flatten a 32x32 grid to 1D frame
                function flattenGridLocal(grid) {
                    const frame = [];
                    for (let y = 0; y < grid.length; y++) {
                        const row = grid[y] || [];
                        for (let x = 0; x < row.length; x++) {
                            frame.push(row[x] || 0);
                        }
                    }
                    return frame;
                }

                let animTimer = null;
                let frameIndex = 0;

                function stopAnimation() {
                    if (animTimer) {
                        clearInterval(animTimer);
                        animTimer = null;
                    }
                }

                function startAnimation() {
                    stopAnimation();

                    const session = getSelectedSession();
                    const frames = (session.frames && session.frames.length)
                        ? session.frames
                        : [session.grid];

                    if (!frames.length || !window.HeatmapSim || typeof HeatmapSim.drawHeatmap !== 'function') {
                        return;
                    }

                    if (lblTimestamp) lblTimestamp.textContent = session.dateKey;

                    const palette = paletteSelect ? (paletteSelect.value || 'default') : 'default';

                    frameIndex = 0;

                    animTimer = setInterval(() => {
                        const grid = frames[frameIndex % frames.length];
                        const flat = flattenGridLocal(grid);
                        HeatmapSim.drawHeatmap(canvas, flat, palette);
                        frameIndex++;
                    }, 80); // 80ms ~ 12.5 FPS
                }

                // Kick off animation
                startAnimation();

                if (dateSelect) {
                    dateSelect.addEventListener('change', () => {
                        startAnimation();
                    });
                }
                if (paletteSelect) {
                    paletteSelect.addEventListener('change', () => {
                        startAnimation();
                    });
                }

            } catch (err) {
                console.error('Error initialising patient dashboard', err);
            }
        });
    </script>
}
