@using System.Security.Claims
@{
    ViewData["Title"] = "Patient Dashboard";

    var userEmail = User.Identity?.Name ?? "patient@demo";
    var patientIdClaim = User.FindFirst("PatientId")?.Value ?? "";
}

<div class="container py-4">

    <!-- HERO / INTRO -->
    <section class="mb-4">
        <div class="hero-slab p-4 p-md-5 text-light d-flex flex-column justify-content-center">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
                <div>
                    <span class="badge text-bg-primary mb-3">Patient view</span>
                    <h1 class="display-6 mb-2">
                        Welcome back,<br />
                        <span class="fw-semibold">@userEmail</span>
                    </h1>
                    <p class="text-muted mb-0">
                        This dashboard summarises your recent pressure mapping sessions and highlights any
                        areas that may need attention. Your clinician can also view this data remotely.
                    </p>
                </div>
                <div class="text-md-end small text-muted">
                    <div class="mb-1">
                        <i class="bi bi-file-medical me-1"></i>
                        <span class="text-uppercase" style="letter-spacing:.12em;">Patient ID</span>
                        <span class="ms-1 fw-semibold">@patientIdClaim</span>
                    </div>
                    <div>
                        <i class="bi bi-activity me-1"></i>
                        Live pressure mapping
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- PRESSURE THRESHOLD (My Pressure Dashboard) -->
    <section class="mb-4">
        <div class="card hero-slab">
            <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-3">
                <div>
                    <h2 class="h5 mb-1">My Pressure Dashboard</h2>
                    <div class="small text-muted">
                        Alerts trigger when peak pressure exceeds your limit.
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <label class="small text-muted mb-0 me-1">Max pressure (mmHg)</label>
                    <input id="maxPressureInput"
                           type="number"
                           class="form-control form-control-sm"
                           style="width: 80px;"
                           value="220" />
                    <button id="btnSaveThreshold" class="btn btn-primary btn-sm">
                        <i class="bi bi-save me-1"></i>Save
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- KPI STRIP -->
    <section class="mb-4">
        <div class="row g-3">
            <!-- Overall status card -->
            <div class="col-md-4">
                <div class="card kpi h-100">
                    <div class="card-body d-flex flex-column justify-content-between">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="kpi-label text-uppercase small">Overall status</div>
                            <div class="bi bi-activity kpi-icon"></div>
                        </div>
                        <div class="kpi-value small mb-2" id="kpiOverallLabel">—</div>
                        <p class="kpi-subtext mb-0">
                            Live per-session metrics in the map.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Latest PPI -->
            <div class="col-md-4">
                <div class="card kpi h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="kpi-label text-uppercase small">Latest PPI</div>
                            <div class="bi bi-bullseye kpi-icon"></div>
                        </div>
                        <div class="kpi-value" id="kpiLatestPpi">—</div>
                        <div class="kpi-subtext">From your most recent session</div>
                    </div>
                </div>
            </div>

            <!-- Latest Contact Area -->
            <div class="col-md-4">
                <div class="card kpi h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="kpi-label text-uppercase small">Latest contact %</div>
                            <div class="bi bi-grid-3x3-gap kpi-icon"></div>
                        </div>
                        <div class="kpi-value" id="kpiLatestContact">—</div>
                        <div class="kpi-subtext">How much of the surface is loaded</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- TREND + HEATMAP -->
    <section class="mb-4">
        <div class="row g-3">
            <!-- Trend over time -->
            <div class="col-lg-7">
                <div class="card shadow-sm h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-uppercase small text-muted mb-1">Trend over time</div>
                            <div class="fw-semibold">Peak pressure vs contact area</div>
                        </div>
                        <div class="btn-group" role="group" aria-label="Time range">
                            <button type="button" class="btn btn-outline-secondary btn-sm active" data-range="1">Last 1h</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-range="6">Last 6h</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-range="24">Last 24h</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="ratio ratio-16x9">
                            <canvas id="trendChart"></canvas>
                        </div>
                        <p class="small text-muted mt-3 mb-0">
                            Each point summarises a recorded session. The blue line shows the
                            <span class="fw-semibold">Peak Pressure Index</span> (highest pressure),
                            and the green line shows
                            <span class="fw-semibold">Contact Area %</span> (how much of the surface is loaded).
                        </p>
                    </div>
                </div>
            </div>

            <!-- Heatmap -->
            <div class="col-lg-5">
                <div class="card heatmap-card shadow-sm h-100">
                    <div class="card-header fw-semibold d-flex align-items-center gap-2">
                        <i class="bi bi-grid-3x3-gap-fill text-primary me-2"></i>
                        <span>Pressure Map</span>

                        <div class="ms-auto d-flex flex-wrap gap-2 align-items-center">
                            <select id="hmDate" class="form-select form-select-sm" style="min-width:140px;">
                                <option value="">Date…</option>
                            </select>

                            <select id="hmPalette" class="form-select form-select-sm">
                                <option value="default">Default Palette</option>
                                <option value="warm">Warm Gradient</option>
                                <option value="cool">Cool Gradient</option>
                                <option value="contrast">High Contrast</option>
                            </select>
                        </div>
                    </div>

                    <div class="card-body p-0 d-flex flex-column">
                        <div class="heatmap-wrap ratio ratio-1x1">
                            <canvas id="heatmapCanvas"></canvas>
                        </div>

                        <!-- KPI row under heatmap -->
                        <div class="d-flex flex-wrap justify-content-between gap-3 px-3 pt-3 pb-2 small">
                            <div>
                                <div class="text-muted text-uppercase" style="font-size:.7rem;letter-spacing:.12em;">
                                    Peak Pressure Index
                                </div>
                                <div id="hmKpiPpi" class="fw-bold">—</div>
                            </div>
                            <div>
                                <div class="text-muted text-uppercase" style="font-size:.7rem;letter-spacing:.12em;">
                                    Contact Area %
                                </div>
                                <div id="hmKpiContact" class="fw-bold">—</div>
                            </div>
                            <div>
                                <div class="text-muted text-uppercase" style="font-size:.7rem;letter-spacing:.12em;">
                                    Status
                                </div>
                                <div id="hmKpiStatus" class="fw-bold">—</div>
                            </div>
                        </div>

                        <!-- Playback controls -->
                        <div class="px-3 pb-3 d-flex align-items-center gap-3">
                            <button id="hmBtnPlay" class="btn btn-sm btn-outline-light rounded-circle">
                                <i class="bi bi-play-fill"></i>
                            </button>
                            <input id="hmFrameSlider" type="range" class="form-range flex-grow-1" min="0" max="0" value="0" />
                            <small id="hmFrameTime" class="text-muted">0.0s / 0.0s</small>
                        </div>

                        <div class="px-3 pb-3 small text-muted" id="hmStatusText">
                            Loading your latest session map…
                        </div>
                    </div>

                    <div class="card-footer small d-flex justify-content-between text-muted">
                        <span id="hmSessionCaption">—</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- SESSION HISTORY PLACEHOLDER -->
    <section class="mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-2">Session history (placeholder)</h5>
                <p class="small text-muted mb-0">
                    Your trend chart is now driven by real session metrics (PPI &amp; contact area). You can
                    expand this section later to show a table of sessions, notes, or export options.
                </p>
            </div>
        </div>
    </section>

    <!-- FEEDBACK / COMMENTS -->
    <section class="mb-5">
        <div class="card">
            <div class="card-header fw-semibold">
                My feedback (linked to current session)
            </div>
            <div class="card-body" id="commentsThread">
                <div class="small text-muted">
                    No comments yet. Add one below.
                </div>
            </div>
            <div class="card-footer">
                <form id="commentForm" class="d-flex gap-2">
                    <input type="text"
                           id="commentInput"
                           class="form-control"
                           placeholder="Describe discomfort, posture, or mat issues..." />
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send me-1"></i>
                        Send (tags current session)
                    </button>
                </form>
            </div>
        </div>
    </section>
</div>

@section Scripts {
    <!-- Re-use your existing helpers -->
    <script src="~/js/charts.js" asp-append-version="true"></script>
    <script src="~/js/heatmap.js" asp-append-version="true"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>

    <script>
        // ----- Context from server -----
        const PATIENT_ID = '@patientIdClaim';

        // Index of available CSV files (same mapping you sent)
        const SENSOR_INDEX = {
            patients: {
                "1c0fd777": {
                    name: "Michael Eton",
                    files: {
                        "2025-10-11": "1c0fd777_20251011.csv",
                        "2025-10-12": "1c0fd777_20251012.csv",
                        "2025-10-13": "1c0fd777_20251013.csv"
                    }
                },
                "71e66ab3": {
                    name: "Jason Ghanian",
                    files: {
                        "2025-10-11": "71e66ab3_20251011.csv",
                        "2025-10-12": "71e66ab3_20251012.csv",
                        "2025-10-13": "71e66ab3_20251013.csv"
                    }
                },
                "543d4676": {
                    name: "Alex Jenkins",
                    files: {
                        "2025-10-11": "543d4676_20251011.csv",
                        "2025-10-12": "543d4676_20251012.csv",
                        "2025-10-13": "543d4676_20251013.csv"
                    }
                },
                "d13043b3": {
                    name: "Richard Afana",
                    files: {
                        "2025-10-11": "d13043b3_20251011.csv",
                        "2025-10-12": "d13043b3_20251012.csv",
                        "2025-10-13": "d13043b3_20251013.csv"
                    }
                },
                "de0e9b2c": {
                    name: "De Luca",
                    files: {
                        "2025-10-11": "de0e9b2c_20251011.csv",
                        "2025-10-12": "de0e9b2c_20251012.csv",
                        "2025-10-13": "de0e9b2c_20251013.csv"
                    }
                }
            }
        };

        const SENSOR_BASE_URL = "/sensor-data/";
        const BASELINE_VALUE = 1;
        const CONTACT_THRESHOLD = 5;
        const ALERT_AREA_THRESHOLD = 70;
        const ROWS_PER_FRAME = 32;
        const COLS_PER_FRAME = 32;
        const MAX_FRAMES = 300;          // play first 300 frames
        const FRAME_DURATION_MS = 33;    // ~30fps, 10s for 300 frames

        // Threshold is user-configurable; default 220
        let ALERT_PPI_THRESHOLD = 220;

        document.addEventListener("DOMContentLoaded", () => {
            setupThreshold();
            initPatientDashboard();
            setupComments();
        });

        // ==========================
        // 1) Threshold persistence
        // ==========================
        function setupThreshold() {
            const input = document.getElementById('maxPressureInput');
            const btnSave = document.getElementById('btnSaveThreshold');
            if (!input || !btnSave) return;

            const patientKey = PATIENT_ID || 'anon';
            const STORAGE_KEY = 'sensore:maxPpi:' + patientKey;

            const saved = window.localStorage.getItem(STORAGE_KEY);
            if (saved) {
                input.value = saved;
                ALERT_PPI_THRESHOLD = Number(saved);
            }

            btnSave.addEventListener('click', () => {
                const v = Number(input.value);
                if (!Number.isFinite(v) || v <= 0) {
                    alert('Please enter a valid positive pressure value.');
                    return;
                }
                window.localStorage.setItem(STORAGE_KEY, String(v));
                ALERT_PPI_THRESHOLD = v;
            });
        }

        // ==========================
        // 2) Patient dashboard wiring
        // ==========================
        async function initPatientDashboard() {
            const patientMeta = SENSOR_INDEX.patients[PATIENT_ID];
            const statusEl = document.getElementById("hmStatusText");

            if (!PATIENT_ID || !patientMeta) {
                statusEl.textContent = "No patient mapping found for this login.";
                return;
            }

            const hmDateSel = document.getElementById("hmDate");
            const hmPalette = document.getElementById("hmPalette");
            const hmCanvas = document.getElementById("heatmapCanvas");
            const hmKpiPpi = document.getElementById("hmKpiPpi");
            const hmKpiContact = document.getElementById("hmKpiContact");
            const hmKpiStatus = document.getElementById("hmKpiStatus");
            const hmSessionCaption = document.getElementById("hmSessionCaption");
            const hmBtnPlay = document.getElementById("hmBtnPlay");
            const hmFrameSlider = document.getElementById("hmFrameSlider");
            const hmFrameTime = document.getElementById("hmFrameTime");

            const kpiOverallLabel = document.getElementById("kpiOverallLabel");
            const kpiLatestPpi = document.getElementById("kpiLatestPpi");
            const kpiLatestContact = document.getElementById("kpiLatestContact");

            // ---- Load sessions for this patient (one per date) ----
            const sessions = {}; // date -> { frames, ppi, contactPct, alert }
            const dateKeys = Object.keys(patientMeta.files).sort();

            for (const dateKey of dateKeys) {
                const fileName = patientMeta.files[dateKey];
                const url = SENSOR_BASE_URL + fileName;

                try {
                    const csv = await fetch(url).then(r => {
                        if (!r.ok) throw new Error("HTTP " + r.status);
                        return r.text();
                    });

                    const frames = parseCsvToFrames(csv, MAX_FRAMES);
                    if (!frames.length) continue;

                    const metrics = computeSessionMetrics(frames);
                    const alert = computeAlert(metrics.ppi, metrics.contactPct);

                    sessions[dateKey] = {
                        frames,
                        ppi: metrics.ppi,
                        contactPct: metrics.contactPct,
                        alert
                    };
                } catch (err) {
                    console.error("Error loading", url, err);
                }
            }

            const availableDates = Object.keys(sessions).sort();
            if (availableDates.length === 0) {
                statusEl.textContent = "No valid sessions were found for your account.";
                return;
            }

            // ---- Populate date dropdown ----
            hmDateSel.innerHTML = "";
            for (const d of availableDates) {
                const opt = document.createElement("option");
                opt.value = d;
                opt.textContent = d;
                hmDateSel.appendChild(opt);
            }
            // default: latest date
            hmDateSel.value = availableDates[availableDates.length - 1];

            // ---- KPIs from most recent session ----
            const latest = sessions[hmDateSel.value];
            kpiLatestPpi.textContent = latest.ppi.toFixed(0);
            kpiLatestContact.textContent = latest.contactPct.toFixed(1) + " %";
            kpiOverallLabel.textContent = latest.alert.label;
            kpiOverallLabel.classList.add(alertClassToBootstrap(latest.alert.cssClass));

            // ---- Build TREND chart ----
            const labels = availableDates;
            const ppiSeries = labels.map(d => sessions[d].ppi);
            const contactSeries = labels.map(d => sessions[d].contactPct);

            const chartCtx = document.getElementById("trendChart").getContext("2d");
            const trendChart = Charts.mkCompareChart(
                chartCtx,
                labels,
                ppiSeries,
                contactSeries,
                "Peak Pressure Index",
                "Contact Area %"
            );

            // simple range buttons: 1h = latest point, 6h = last 2, 24h = all
            const rangeButtons = document.querySelectorAll('[data-range]');
            rangeButtons.forEach(btn => {
                btn.addEventListener("click", () => {
                    rangeButtons.forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    const range = btn.getAttribute("data-range");

                    let count = labels.length;
                    if (range === "1") count = 1;
                    else if (range === "6") count = Math.min(2, labels.length);
                    else count = labels.length;

                    const subLabels = labels.slice(-count);
                    const subPpi = ppiSeries.slice(-count);
                    const subContact = contactSeries.slice(-count);

                    trendChart.data.labels = subLabels;
                    trendChart.data.datasets[0].data = subPpi;
                    trendChart.data.datasets[1].data = subContact;
                    trendChart.update();
                });
            });

            // ---- Heatmap playback wiring ----
            let currentFrames = [];
            let currentDateKey = null;
            let timerId = null;
            let playing = false;

            function stopPlayback() {
                if (timerId) {
                    clearInterval(timerId);
                    timerId = null;
                }
                playing = false;
                hmBtnPlay.innerHTML = '<i class="bi bi-play-fill"></i>';
            }

            function startPlayback() {
                if (!currentFrames.length) return;
                stopPlayback();

                const palName = mapPalette(hmPalette.value);
                const totalFrames = currentFrames.length;

                hmFrameSlider.max = totalFrames - 1;

                timerId = setInterval(() => {
                    let idx = Number(hmFrameSlider.value);
                    idx = (idx + 1) % totalFrames;
                    hmFrameSlider.value = idx;

                    const frame = currentFrames[idx];
                    HeatmapSim.drawHeatmap(hmCanvas, frame, palName);

                    const t = (idx + 1) * FRAME_DURATION_MS / 1000;
                    const totalT = totalFrames * FRAME_DURATION_MS / 1000;
                    hmFrameTime.textContent = t.toFixed(1) + "s / " + totalT.toFixed(1) + "s";
                }, FRAME_DURATION_MS);

                playing = true;
                hmBtnPlay.innerHTML = '<i class="bi bi-pause-fill"></i>';
            }

            function setSession(dateKey) {
                const session = sessions[dateKey];
                if (!session) return;

                currentDateKey = dateKey;
                currentFrames = session.frames;
                hmFrameSlider.value = 0;

                // Update KPIs under the map
                hmKpiPpi.textContent = session.ppi.toFixed(0);
                hmKpiContact.textContent = session.contactPct.toFixed(1) + " %";
                hmKpiStatus.textContent = session.alert.label;
                hmKpiStatus.className = "fw-bold " + session.alert.cssClass;

                statusEl.textContent = `${patientMeta.name} • ${dateKey}`;
                hmSessionCaption.textContent = `${patientMeta.name} • ${dateKey}`;

                const palName = mapPalette(hmPalette.value);
                HeatmapSim.drawHeatmap(hmCanvas, currentFrames[0], palName);

                const totalT = currentFrames.length * FRAME_DURATION_MS / 1000;
                hmFrameTime.textContent = "0.0s / " + totalT.toFixed(1) + "s";

                if (playing) {
                    startPlayback();
                }
            }

            hmDateSel.addEventListener("change", () => {
                stopPlayback();
                setSession(hmDateSel.value);
            });

            hmPalette.addEventListener("change", () => {
                if (!currentFrames.length) return;
                const palName = mapPalette(hmPalette.value);
                const idx = Number(hmFrameSlider.value);
                HeatmapSim.drawHeatmap(hmCanvas, currentFrames[idx], palName);
            });

            hmBtnPlay.addEventListener("click", () => {
                if (playing) {
                    stopPlayback();
                } else {
                    startPlayback();
                }
            });

            hmFrameSlider.addEventListener("input", () => {
                if (!currentFrames.length) return;
                const idx = Number(hmFrameSlider.value);
                const palName = mapPalette(hmPalette.value);
                HeatmapSim.drawHeatmap(hmCanvas, currentFrames[idx], palName);

                const t = (idx + 1) * FRAME_DURATION_MS / 1000;
                const totalT = currentFrames.length * FRAME_DURATION_MS / 1000;
                hmFrameTime.textContent = t.toFixed(1) + "s / " + totalT.toFixed(1) + "s";
            });

            // initialise with the latest session
            setSession(hmDateSel.value);
        }

        // ----- CSV -> frames (array of flattened 32x32 frames) -----
        function parseCsvToFrames(csvText, maxFrames) {
            const lines = csvText.trim().split(/\r?\n/).filter(l => l.trim() !== "");
            const totalFrames = Math.min(Math.floor(lines.length / ROWS_PER_FRAME), maxFrames || Infinity);

            const frames = [];

            for (let f = 0; f < totalFrames; f++) {
                const flat = [];
                for (let r = 0; r < ROWS_PER_FRAME; r++) {
                    const line = lines[f * ROWS_PER_FRAME + r];
                    const parts = line.split(/[,;\s]+/).filter(p => p.length > 0);
                    for (let c = 0; c < COLS_PER_FRAME; c++) {
                        const v = Number(parts[c] ?? BASELINE_VALUE);
                        flat.push(Number.isFinite(v) ? v : BASELINE_VALUE);
                    }
                }
                frames.push(flat);
            }

            return frames;
        }

        // ----- Session metrics (across all frames) -----
        function computeSessionMetrics(frames) {
            let maxVal = 0;
            let sumContactPct = 0;

            for (const frame of frames) {
                const ppi = computePPI(frame);
                if (ppi > maxVal) maxVal = ppi;

                sumContactPct += computeContactAreaPct(frame, CONTACT_THRESHOLD);
            }

            const contactAvg = frames.length ? (sumContactPct / frames.length) : 0;

            return {
                ppi: maxVal,
                contactPct: contactAvg
            };
        }

        function computePPI(frame) {
            let maxVal = 0;
            for (const v of frame) {
                if (v > BASELINE_VALUE && v > maxVal) {
                    maxVal = v;
                }
            }
            return maxVal;
        }

        function computeContactAreaPct(frame, threshold) {
            const total = frame.length || 1;
            let count = 0;
            for (const v of frame) {
                if (v > threshold) count++;
            }
            return (count / total) * 100.0;
        }

        function computeAlert(ppi, contactPct) {
            if (ppi >= ALERT_PPI_THRESHOLD || contactPct >= ALERT_AREA_THRESHOLD) {
                return { label: "High risk", cssClass: "text-danger" };
            }
            if (ppi > BASELINE_VALUE + 10 || contactPct > 10) {
                return { label: "Monitor", cssClass: "text-warning" };
            }
            return { label: "Stable", cssClass: "text-success" };
        }

        function mapPalette(uiValue) {
            switch (uiValue) {
                case "warm": return "inferno";
                case "cool": return "viridis";
                case "contrast": return "gray";
                case "default":
                default: return "inferno";
            }
        }

        function alertClassToBootstrap(cssClass) {
            if (cssClass.includes("danger")) return "text-danger";
            if (cssClass.includes("warning")) return "text-warning";
            if (cssClass.includes("success")) return "text-success";
            return "";
        }

        // ==========================
        // 3) Comments per session
        // ==========================
        function setupComments() {
            const form = document.getElementById('commentForm');
            const input = document.getElementById('commentInput');
            const thread = document.getElementById('commentsThread');
            if (!form || !input || !thread) return;

            const patientKey = PATIENT_ID || 'anon';
            const STORAGE_KEY = 'sensore:comments:' + patientKey;

            function loadComments() {
                const json = window.localStorage.getItem(STORAGE_KEY);
                return json ? JSON.parse(json) : [];
            }

            function saveComments(list) {
                window.localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
            }

            function renderComments() {
                const list = loadComments();
                thread.innerHTML = '';
                if (!list.length) {
                    thread.innerHTML = '<div class="small text-muted">No comments yet. Add one below.</div>';
                    return;
                }
                list.forEach(function (c) {
                    const row = document.createElement('div');
                    row.className = 'mb-2 small';
                    row.innerHTML =
                        '<strong>' + c.date + '</strong> &middot; ' +
                        '<span class="text-muted">' + (c.session || 'session') + '</span><br/>' +
                        c.text;
                    thread.appendChild(row);
                });
            }

            renderComments();

            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const text = input.value.trim();
                if (!text) return;

                const sessionDate = document.getElementById('hmDate')
                    ? document.getElementById('hmDate').value || 'latest'
                    : 'latest';

                const entry = {
                    date: new Date().toLocaleString(),
                    session: sessionDate,
                    text: text
                };

                const list = loadComments();
                list.unshift(entry);
                saveComments(list);
                input.value = '';
                renderComments();
            });
        }
    </script>
}
