@{
    ViewData["Title"] = "Patient Dashboard";
    Layout = "_Layout";
}

<div class="container py-4">
    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
        <div class="d-flex align-items-center">
            <i class="bi bi-heart-pulse fs-3 text-primary me-2"></i>
            <h2 class="fw-semibold mb-0">My Pressure Dashboard</h2>
        </div>
        <div class="small text-muted">
            Signed in as <strong>@User.Identity?.Name</strong>
        </div>
    </div>

    <!-- ALERT BANNER -->
    <div id="alertBanner" class="alert alert-warning d-none align-items-center gap-2" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span id="alertText">High pressure detected. Please adjust your position.</span>
    </div>

    <!-- KPIs -->
    <section class="my-3">
        <div class="row g-3">
            <div class="col-6 col-lg-3">
                <div class="card kpi p-3">
                    <div class="kpi-label">Peak Pressure</div>
                    <div id="kpiPeak" class="kpi-value">â€”</div>
                    <div id="kpiPeakTrend" class="kpi-subtext">vs previous</div>
                </div>
            </div>
            <div class="col-6 col-lg-3">
                <div class="card kpi p-3">
                    <div class="kpi-label">Contact Area %</div>
                    <div id="kpiArea" class="kpi-value">â€”</div>
                    <div id="kpiAreaTrend" class="kpi-subtext">vs previous</div>
                </div>
            </div>
            <div class="col-6 col-lg-3">
                <div class="card kpi p-3">
                    <div class="kpi-label">Alerts Today</div>
                    <div id="kpiAlerts" class="kpi-value">â€”</div>
                    <div class="kpi-subtext">exceeding safe limits</div>
                </div>
            </div>
            <div class="col-6 col-lg-3">
                <div class="card kpi p-3">
                    <div class="kpi-label">Comfort Index</div>
                    <div id="kpiComfort" class="kpi-value">â€”</div>
                    <div class="kpi-subtext">higher is better</div>
                </div>
            </div>
        </div>
    </section>

    <!-- HEATMAP + TIMELINE -->
    <section class="my-4">
        <div class="row g-3">
            <div class="col-lg-6">
                <div class="card heatmap-card">
                    <div class="card-header d-flex align-items-center justify-content-between fw-semibold">
                        <span>Live Pressure Map</span>
                        <div class="d-flex align-items-center gap-2">
                            <select id="paletteSelect" class="form-select form-select-sm" style="width:auto;">
                                <option value="default">Default</option>
                                <option value="warm">Warm</option>
                                <option value="cool">Cool</option>
                                <option value="contrast">High Contrast</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="heatmap-wrap ratio ratio-1x1">
                            <canvas id="heatmapCanvas"></canvas>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex align-items-center gap-3 flex-wrap">
                            <button id="btnPlay" class="btn btn-primary btn-sm">
                                <i class="bi bi-play-fill me-1"></i><span>Play</span>
                            </button>
                            <div class="flex-grow-1">
                                <input type="range" class="form-range" id="timelineRange" min="0" max="299" value="0">
                                <div class="d-flex justify-content-between small mt-1">
                                    <span id="timelineStart">Start</span>
                                    <span id="timelineNow">Now</span>
                                </div>
                            </div>
                            <span class="badge text-bg-primary" id="frameTime">00:00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metrics charts -->
            <div class="col-lg-6">
                <div class="card p-3">
                    <div class="card-header fw-semibold">My Metrics</div>
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="ratio ratio-16x9"><canvas id="chartPeak"></canvas></div>
                        </div>
                        <div class="col-12">
                            <div class="ratio ratio-16x9"><canvas id="chartArea"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- TIMELINE ALERTS LIST -->
    <section class="my-4">
        <div class="card">
            <div class="card-header fw-semibold">
                <i class="bi bi-bell text-warning me-2"></i>Alerts on Timeline
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="tblTimelineAlerts">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Peak Pressure</th>
                            <th>Duration</th>
                            <th>Region</th>
                            <th>Tip</th>
                        </tr>
                    </thead>
                    <tbody><!-- JS renders --></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- COMMENTS / FEEDBACK (timestamped) -->
    <section class="my-4">
        <div class="card shadow-sm">
            <div class="card-header fw-semibold">
                <i class="bi bi-chat-dots text-primary me-2"></i>My Feedback (linked to current time)
            </div>
            <div class="card-body" id="commentsThread">
                <div class="text-muted small">No comments yet. Add one below.</div>
            </div>
            <div class="card-footer">
                <form id="commentForm" class="d-flex align-items-center gap-2">
                    <input type="text" id="commentInput" class="form-control" placeholder="Describe discomfort, posture, or mat issuesâ€¦" />
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send me-1"></i>Send (tags current time)
                    </button>
                </form>
            </div>
        </div>
    </section>

    <!-- REPORTS + ENCOURAGEMENT -->
    <section class="my-4">
        <div class="card">
            <div class="card-header fw-semibold d-flex align-items-center justify-content-between">
                <span><i class="bi bi-file-earmark-bar-graph text-primary me-2"></i>My Daily/Weekly Summary</span>
                <div class="d-flex gap-2">
                    <button id="btnExportCsv" class="btn btn-primary btn-sm">
                        <i class="bi bi-download me-1"></i>Download CSV
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="kpi-card">
                            <div class="kpi-title">Todayâ€™s Peak Pressure</div>
                            <div id="repPeak" class="kpi-value">â€”</div>
                            <div id="repPeakTrend" class="kpi-trend">â€” vs yesterday</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="kpi-card">
                            <div class="kpi-title">Average Contact Area</div>
                            <div id="repArea" class="kpi-value">â€”</div>
                            <div id="repAreaTrend" class="kpi-trend">â€” vs yesterday</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="kpi-card">
                            <div class="kpi-title">Alerts Resolved</div>
                            <div id="repResolved" class="kpi-value">â€”</div>
                            <div id="repPending" class="kpi-trend">â€” pending</div>
                        </div>
                    </div>
                </div>

                <div id="encouragement" class="mt-3 p-3 rounded-4" style="background:rgba(32,212,122,.08); border:1px solid rgba(32,212,122,.35);">
                    <i class="bi bi-emoji-smile text-success me-2"></i>
                    <span class="text-success fw-semibold">Great progress!</span>
                    <span class="text-muted"> Your peak pressure is lower than yesterday. Keep it up! ðŸŽ‰</span>
                </div>
            </div>
        </div>
    </section>
</div>

@section Scripts {
<script>
// =========================
// Demo data (client-only)
// =========================
const FRAMES = 300;          // 5 minutes at 1 sec/frame (demo)
const SAFE_LIMIT = 100;      // mmHg threshold for alert
let frameIndex = 0;
let playing = false;
let playTimer;

// mock per-frame metrics (peak, area, comfort)
const seriesPeak = Array.from({length: FRAMES}, (_,i)=> Math.round(75 + 20*Math.sin(i/18) + 10*Math.random()));
const seriesArea = Array.from({length: FRAMES}, (_,i)=> Math.round(60 + 6*Math.cos(i/22) + 3*Math.random()));
const seriesComfort = Array.from({length: FRAMES}, (_,i)=> Math.max(0, Math.min(100, 92 - (seriesPeak[i]-85)/0.8)));

const timelineAlerts = [];
for (let i=0;i<FRAMES;i++){
    if (seriesPeak[i] > SAFE_LIMIT) {
        timelineAlerts.push({
            t: i, peak: seriesPeak[i],
            dur: (1 + Math.floor(Math.random()*5)) + "m",
            region: ["Left Heel","Right Heel","Sacrum","Hip"][Math.floor(Math.random()*4)],
            tip: "Try adjusting posture slightly."
        });
    }
}

// =========================
// Elements
// =========================
const elRange = document.getElementById('timelineRange');
const elPlay  = document.getElementById('btnPlay');
const elFrame = document.getElementById('frameTime');
const elPeak  = document.getElementById('kpiPeak');
const elArea  = document.getElementById('kpiArea');
const elAlerts= document.getElementById('kpiAlerts');
const elComfort=document.getElementById('kpiComfort');
const elPeakTrend=document.getElementById('kpiPeakTrend');
const elAreaTrend=document.getElementById('kpiAreaTrend');
const elAlertBanner=document.getElementById('alertBanner');
const elAlertText=document.getElementById('alertText');
const elEncouragement=document.getElementById('encouragement');

function fmtTime(sec){
    const m = Math.floor(sec/60).toString().padStart(2,'0');
    const s = (sec%60).toString().padStart(2,'0');
    return `${m}:${s}`;
}

// =========================
// Heatmap renderer (demo)
// =========================
const canvas = document.getElementById('heatmapCanvas');
const ctx = canvas.getContext('2d');
function resizeCanvas(){
  const rect = canvas.parentElement.getBoundingClientRect();
  const size = Math.min(rect.width, rect.height);
  canvas.width = size; canvas.height = size;
}
window.addEventListener('resize', resizeCanvas); resizeCanvas();

function drawHeatmap(frame, palette="default"){
  const w = canvas.width, h = canvas.height;
  // base gradient
  const g = ctx.createLinearGradient(0,0,w,h);
  if (palette === "warm"){ g.addColorStop(0,"#3b82f6"); g.addColorStop(.5,"#f59e0b"); g.addColorStop(1,"#ef4444"); }
  else if (palette === "cool"){ g.addColorStop(0,"#111827"); g.addColorStop(.5,"#1d4ed8"); g.addColorStop(1,"#22d3ee"); }
  else if (palette === "contrast"){ g.addColorStop(0,"#0ea5e9"); g.addColorStop(.5,"#10b981"); g.addColorStop(1,"#ef4444"); }
  else { g.addColorStop(0,"#1e3a8a"); g.addColorStop(.5,"#3b82f6"); g.addColorStop(1,"#f59e0b"); }
  ctx.fillStyle = g; ctx.fillRect(0,0,w,h);

  // hotspot
  const cx = w*(0.35 + 0.25*Math.sin(frame/20));
  const cy = h*(0.45 + 0.25*Math.cos(frame/23));
  const r  = Math.max(40, 60 + 20*Math.sin(frame/15));
  const hot = ctx.createRadialGradient(cx,cy, r*0.2, cx,cy, r);
  const peak = seriesPeak[frame];
  const alpha = Math.min(1, (peak-70)/50);
  hot.addColorStop(0, `rgba(255, 80, 0, ${0.75*alpha})`);
  hot.addColorStop(1, "rgba(255,255,255,0)");
  ctx.fillStyle = hot; ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();
}

// =========================
// Charts
// =========================
let charts = {};
function buildCharts(){
  const tick = getComputedStyle(document.documentElement).getPropertyValue('--chart-tick').trim() || '#cbd5e1';
  const grid = getComputedStyle(document.documentElement).getPropertyValue('--chart-grid').trim() || 'rgba(255,255,255,.06)';
  const common = {
    plugins:{ legend:{ display:false } },
    scales:{ x:{ grid:{color:grid}, ticks:{color:tick} }, y:{ grid:{color:grid}, ticks:{color:tick} } }
  };
  charts.peak = new Chart(document.getElementById('chartPeak'), {
    type:'line',
    data:{ labels: Array.from({length: FRAMES}, (_,i)=> i),
           datasets:[{ label:'Peak Pressure', data: seriesPeak, fill:true,
                       borderColor:'#5b7cfa', backgroundColor:'rgba(91,124,250,.18)', tension:.35 }]},
    options: common
  });
  charts.area = new Chart(document.getElementById('chartArea'), {
    type:'line',
    data:{ labels: Array.from({length: FRAMES}, (_,i)=> i),
           datasets:[{ label:'Contact Area %', data: seriesArea, fill:true,
                       borderColor:'#4de2c2', backgroundColor:'rgba(77,226,194,.18)', tension:.35 }]},
    options: common
  });
}

// =========================
// Timeline + KPIs
// =========================
function updateUI(){
  // frame time
  elFrame.textContent = fmtTime(frameIndex);

  // heatmap & palette
  const palette = document.getElementById('paletteSelect').value;
  drawHeatmap(frameIndex, palette);

  // KPIs (current frame)
  const pk = seriesPeak[frameIndex];
  const ar = seriesArea[frameIndex];
  const cf = seriesComfort[frameIndex];
  elPeak.textContent = `${pk} mmHg`;
  elArea.textContent = `${ar}%`;
  elComfort.textContent = `${cf}%`;

  // trends vs previous frame
  const prev = Math.max(0, frameIndex-1);
  const dPk = pk - seriesPeak[prev];
  const dAr = ar - seriesArea[prev];
  elPeakTrend.textContent = `${dPk>=0?'+':''}${dPk} vs prev`;
  elAreaTrend.textContent = `${dAr>=0?'+':''}${dAr}% vs prev`;

  // alert banner if unsafe
  if (pk > SAFE_LIMIT) {
    elAlertBanner.classList.remove('d-none');
    elAlertText.textContent = `High pressure (${pk} mmHg). Please adjust your position.`;
  } else {
    elAlertBanner.classList.add('d-none');
  }
}

function renderTimelineAlerts(){
  const tbody = document.querySelector('#tblTimelineAlerts tbody');
  tbody.innerHTML = '';
  timelineAlerts.forEach(a=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${fmtTime(a.t)}</td>
      <td>${a.peak} mmHg</td>
      <td>${a.dur}</td>
      <td>${a.region}</td>
      <td class="small text-muted">${a.tip}</td>`;
    tr.style.cursor = 'pointer';
    tr.addEventListener('click', ()=> {
      frameIndex = a.t; elRange.value = frameIndex; updateUI();
    });
    tbody.appendChild(tr);
  });
  elAlerts.textContent = timelineAlerts.length.toString();
}

// =========================
// Comments (timestamped)
// =========================
function addCommentAtCurrentTime(text){
  const container = document.getElementById('commentsThread');
  if (container.querySelector('.text-muted.small')) container.innerHTML = '';
  const wrap = document.createElement('div');
  wrap.className = 'd-flex align-items-start mb-3';
          wrap.innerHTML = `
          <div class="avatar patient me-3">P</div>
          <div>
            <div class="fw-semibold">Me <span class="small text-muted ms-1">@@ ${fmtTime(frameIndex)}</span></div>
            <div class="comment-bubble bg-transparent border rounded p-2">${text}</div>
          </div>`;

  container.appendChild(wrap);
  container.scrollTop = container.scrollHeight;
}

// =========================
// Reports + Encouragement
// =========================
function updateReportSummary(){
  const last = FRAMES-1;
  const todayPeak = seriesPeak[last];
  const yestPeak = 95; // demo baseline
  const todayArea = seriesArea[last];
  const yestArea = 60; // demo baseline
  const resolved = Math.floor(timelineAlerts.length * 0.7);
  const pending  = timelineAlerts.length - resolved;

  document.getElementById('repPeak').textContent = `${todayPeak} mmHg`;
  document.getElementById('repArea').textContent = `${todayArea}%`;
  document.getElementById('repResolved').textContent = resolved.toString();
  document.getElementById('repPending').textContent  = `${pending} pending`;

  const peakDelta = todayPeak - yestPeak;
  const areaDelta = todayArea - yestArea;
  document.getElementById('repPeakTrend').textContent = `${peakDelta>=0?'+':''}${peakDelta} vs yesterday`;
  document.getElementById('repAreaTrend').textContent = `${areaDelta>=0?'+':''}${areaDelta}% vs yesterday`;

  // encouragement if improved
  if (todayPeak < yestPeak) {
    elEncouragement.style.display = 'block';
  } else {
    elEncouragement.style.display = 'none';
  }
}

function exportCsv(){
  const rows = [
    ['Time(sec)', 'Peak(mmHg)', 'Area(%)', 'Comfort(%)'],
    ...Array.from({length: FRAMES}, (_,i)=> [i, seriesPeak[i], seriesArea[i], seriesComfort[i]])
  ];
  const csv = rows.map(r=>r.join(',')).join('\n');
  const url = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
  const a = Object.assign(document.createElement('a'), { href:url, download:'patient_timeseries.csv' });
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

// =========================
// Playback
// =========================
function play(){
  if (playing) return;
  playing = true;
  elPlay.querySelector('span').textContent = 'Pause';
  elPlay.querySelector('i').className = 'bi bi-pause-fill me-1';
  playTimer = setInterval(()=>{
    frameIndex = (frameIndex + 1) % FRAMES;
    elRange.value = frameIndex;
    updateUI();
  }, 250); // 4x speed for demo
}
function pause(){
  playing = false;
  clearInterval(playTimer);
  elPlay.querySelector('span').textContent = 'Play';
  elPlay.querySelector('i').className = 'bi bi-play-fill me-1';
}

// =========================
// Init
// =========================
document.addEventListener('DOMContentLoaded', () => {
  buildCharts();
  renderTimelineAlerts();
  updateReportSummary();

  elRange.addEventListener('input', e=> { frameIndex = +e.target.value; updateUI(); });
  document.getElementById('timelineStart').textContent = '00:00';
  document.getElementById('timelineNow').textContent   = fmtTime(FRAMES-1);

  elPlay.addEventListener('click', ()=> playing ? pause() : play());
  document.getElementById('paletteSelect').addEventListener('change', ()=> updateUI());

  // comments
  document.getElementById('commentForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const txt = document.getElementById('commentInput').value.trim();
    if(!txt) return;
    addCommentAtCurrentTime(txt);
    document.getElementById('commentInput').value = '';
  });

  // export
  document.getElementById('btnExportCsv').addEventListener('click', exportCsv);

  // first render
  updateUI();
});
</script>
}
